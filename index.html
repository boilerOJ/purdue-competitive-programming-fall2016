<!DOCTYPE html>
<html lang="en" ng-app="uHunt">
<head>
<meta charset="utf-8" />
<link rel="stylesheet" href="/css/uhunt.css"/>
<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/cupertino/jquery-ui.css" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.1.4/angular.min.js"></script>
<link rel="shortcut icon" href="/images/uva-rounded.png" />
<style id="uhunt_series_ranklist_style"></style>
<style>
th { font-family: "verdana"; font-size: 12px; }
td { font-family: "verdana"; font-size: 11px; }
.uhunt_text { font-family: "verdana"; font-size: 13px; }
.tab_menu { outline: none; font-size: 15px; }
a.nou  { text-decoration: none; }
a.sub_ac { text-decoration: underline; }
a.sub_wa { color: "orange"; font-weight: bold; }
a.sub_none { text-decoration: none; }
a.sub_2d { /*color: #F00; */ }
a.sub_7d { /*color: #0A0; */ }
a.sub_1m { /*color: #00F; */ }
a.sub_best { font-weight: bold; }
.ellipsis {
  text-decoration: none;
  display: inline-block;
  overflow: hidden;
  text-overflow: ellipsis;
  -o-text-overflow: ellipsis;
  white-space: nowrap;
}
.alt_colors tr:nth-child(even){ background:#F6F6F6; }
.alt_colors tr:nth-child(odd){ background:#FFFFFF; }
.tablebar { 
  border: 1px solid #2694e8;
  font-weight: bold;
  color: #ffffff;
  height: 28px;
  background: #3baae3 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAGQCAYAAABvWArbAAAASklEQVQ4je3PoQ2AQBjF4L7eHYOyJpOwAY4BEGAQGDQJ+c2X2jIv2ylAURS/Zd0PNGBLsAkOg+NRwakFu+BksBvs4S7z9UdRFK9c1/AJQc18gAMAAAAASUVORK5CYII=) 50% 50% repeat-x;
}
.tablesubar {
  background: #deedf7 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAABkCAYAAABHLFpgAAAAL0lEQVQYlWP4+P33fyYGBgaGIUT8R7D+w7n//0NZCDEo6z+mGEIxuo7/mCYPNwIANF0liBOYV+gAAAAASUVORK5CYII=) 50% 50% repeat-x;
}
</style>
</head>

<body style="margin:0; padding:0">
<div style="margin:0 auto; width:1000px;">
<!--<img border="0" src="/images/uva.png" width="70" style="padding-right:15px; float:left">-->

<!-- <div id="uhunt_widget_chat" style="width:580px; height:245px; float:right; padding-left:25px"></div> -->

<div ng-cloak ng-controller="DummyCtrl"></div>

<div class="uhunt_series_widget" style="width:580px; height:245px; display:none">({ name: "ranklist_config_dialog", })</div>
<h1 style="margin:8px 0 20px 0; padding-top:5px; font-size:10px">
<span style="font-family:arial; font-weight:bold; font-size:40px; margin-bottom:0px">Purdue Competitive Programming</span><br style="">
<span style="font-family:arial; font-weight:normal; font-size:15px; font-style:italic">Training Series <b>2016</b></span>
</h1>
<!--<p style="font-family:verdana; font-size:13px">-->
<!--uHunt Training Series is a tool for coaches to create weekly training practice using the-->
<!--existing <a href="http://uva.onlinejudge.org/" target="_blank">UVa OJ</a> problems.-->
<!--You can create your own training series using <a href="https://github.com/felix-halim/uhunt-components/blob/master/series.html" target="_blank">uhunt-components</a>.-->

<!--<br><br>This year (2015), National University of Singapore creates a new training series.-->
<!--You are all welcome to participate!-->

<!--<br><br>Links to the previous-->

<div id="uhunt_series_widget_tabs" style="clear:both; padding-top:10px; width:100%;"></div>
</div>
<br>
<br>
<script src='js/uhunt_lite.js?27' type='text/javascript'></script>
<script>
"use strict";

var series = {
  "id": "29EFA",
  "title": "Weekly practice for ACM ICPC (beta)",
  "description": '<table style="float:right; width:300px; border: 1px solid gray; margin:0 0 25px 25px; font-size:15px" cellspacing="0" cellpadding="4">\
<tr class="tablebar"><th width="60" style="font-size:15px">Week<th align="left" style="font-size:15px"> &nbsp; Topics\
<tr class="topic_table"><th style="font-size:14px">#1<td style="font-size:14px"> &nbsp; Warming Up - Ad Hoc\
<tr class="topic_table"><th style="font-size:14px">#2<td style="font-size:14px"> &nbsp; Data Structures and Libraries\
<tr class="topic_table"><th style="font-size:14px">#3<td style="font-size:14px"> &nbsp; Complete Search\
<tr class="topic_table"><th style="font-size:14px">#4<td style="font-size:14px"> &nbsp; Greedy\
<tr class="topic_table"><th style="font-size:14px">#5<td style="font-size:14px"> &nbsp; Dynamic Programming 1\
<tr class="topic_table"><th style="font-size:14px">#6<td style="font-size:14px"> &nbsp; Dynamic Programming 2\
<tr class="topic_table"><th style="font-size:14px">#7<td style="font-size:14px"> &nbsp; Graphs 1\
<tr class="topic_table"><th style="font-size:14px">#8<td style="font-size:14px"> &nbsp; Graphs 2\
<tr class="topic_table"><th style="font-size:14px">#9<td style="font-size:14px"> &nbsp; Mathematics\
<tr class="topic_table"><th style="font-size:14px">#10<td style="font-size:14px"> &nbsp; String Processing\
<tr class="topic_table"><th style="font-size:14px">#11<td style="font-size:14px"> &nbsp; Mix and Match\
</table>\
<p style="margin-top:0; font-size:14px">\
<table style="width:950px; border: 1px solid gray; margin:0 0 7px 7px; font-size:15px" cellspacing="0" cellpadding="4">\
<thead><tr class="tablebar">\
<th width="50" style="font-size:13px">#\
<th width="180" style="font-size:13px" align="left">User (username)\
<th width="70" style="font-size:13px">Solved\
<th style="font-size:13px">#1\
<th style="font-size:13px">#2\
<th style="font-size:13px">#3\
<th style="font-size:13px">#4\
<th style="font-size:13px">#5\
<th style="font-size:13px">#6\
<th style="font-size:13px">#7\
<th style="font-size:13px">#8\
<th style="font-size:13px">#9\
<th style="font-size:13px">#10\
<th style="font-size:13px">#11\
</thead><tbody id="summary_tbody"></tbody></table>\
',
  "created_ts": 3423423,
  "series": [
    {
        "start_ts": 1472166200000,
        "end_ts": 1473597599000,
        "title": "Warming Up - Ad Hoc Problems",
        "description": "This is the first session in the training series.    This session is meant to familiarize with the UVa Online Judge and uHunt.    The problems in this session do not require advanced data structures and/or algorithms.  The problem set is listed on the table on right. Click on the problem number to see the problem statement.<br><br>  Please read <a href=\"https://sites.google.com/site/stevenhalim/\" target=\"_blank\">Competitive Programming 3 text book</a>   if you are struggling to solve these problems.<br>",
        "prev_hints": "",
        "problems": [
          {id: "10082", hint: ""},
          {id: "10443", hint: ""},
          {id: "10812", hint: ""},
          {id: "10919", hint: ""},
          {id: "11221", hint: ""},
          {id: "11727", hint: ""},
          {id: "11764", hint: ""},
          {id: "12085", hint: ""},
          {id: "12403", hint: ""},
        ],
    },
    {
        "start_ts": 1472767200000,
        "end_ts": 1572597599000,
        "title": "Data Structures and Libraries",
        "description": "Welcome to the second session in the training series.    This session focus on problems that can be easily solved using existing libraries in C++/Java/Python.<br/><br>Union-Find Disjoint Set library: <a href='https://github.com/luisfcofv/competitive-programming-book/blob/master/ch2/ch2_08_unionfind_ds.java'>Java</a> <a href='https://github.com/luisfcofv/competitive-programming-book/blob/master/ch2/ch2_08_unionfind_ds.cpp'>C++</a></br>",
        "problems": [
          {id: "10226", hint: "Use some sort of hashmap to store the # of each tree encountered, then iterate in alphabetic order and print out the frequency as a percent (use printf to format the float)"},
          {id: "11849", hint: "Add N numbers to a HashSet, then check how many of the M numbers are in the set"},
          {id: "10107", hint: "Keep adding numbers to an ArrayList (or other collection), then sort and return the median. This doesn't TLE even though its really slow"},
          {id: "11286", hint: "Use a HashMap to keep track of the frequencies"},
          {id: "11988", hint: "Iterate left to right, storing each character in a linked list. If you see a [, then go to the front of the linked list, if you see a ] then go to the end"},
          {id: "11995", hint: "Create a stack, queue, and priority queue. Perform all operations on all 3, and keep track of errors/resulting values. There are some edge cases."},
          {id: "793", hint: "Add each pair to the Disjoint Set for c pairs, check if pair is in the disjoint set for q pairs"},
          {id: "732", hint: "Use a Stack to simulate the process"},
          {id: "11966", hint: ""},
          {id: "1232", hint: ""},
        ],
    },
    {
        "start_ts": 1473372000000,
        "end_ts": 1572597599000,
        "title": "Complete Search",
        "description": "",
        "problems": [
          {id: "10041", hint: "2 for loops"},
          {id: "10102", hint: "3 for loops"},
          {id: "11059", hint: "2 or 3 for loops"},
          {id: "574", hint: ""},
          {id: "750", hint: ""},
          {id: "11059", hint: ""},
          {id: "11057", hint: "Binary search (needs to be sorted first)"},
          {id: "10567", hint: "Binary search (this one is harder)"},
          {id: "193", hint: "Recursive + backtracking (this one is hard)"},
        ],
    },
]
}

var uhunt_series = (function (){
  var series = null;
  
  var widget = {
    problems: function(problems){
      var res = '';
      $.each(problems, function (i, dict) {
        var num = dict.id;
        var hint = dict.hint;
        var p = uhunt.probs.num(num);
        if (!p) return false;
        res += '<tr>' +
          '<td align=right>' + uhunt.tpl.problem_link(p) +
          '<td> &nbsp;<span style="float:right; padding-right:8px;">' + uhunt.tpl.problem_title(p.pid,p.tit,130 - (uhunt.algorithmist.exists(p.num)? 20 : 0)) + 
          '<td align=center>' + uhunt.probs.level(p.dacu) +
          '<td align=center><span id="session-ac-' + num + '">0</span>'+
          '<td align=center><span id="session-nos-' + num + '">0</span>' +
          '<td align=center><span title="' + hint +  '"id="session-hint-' + num + '">' + (hint != "" ? 'hint' : '') + '</span>';
      });

      return '<table cellspacing=0 cellpadding=2 \
style="border: 1px solid #bbb; font-size:13px; font-family:verdana">\
<thead><tr class="tablebar" style="height:24px">\
  <th width=40 align=right>#\
  <th align=left> &nbsp; Problem Title\
  <th width=60>Difficulty\
  <th width=70>AC\
  <th width=70>NOS\
  <th width=70>Hint\
<tbody class="alt_colors">'+res+'</tbody></table>';
    },

    ranklist_config_dialog: function () {
      return '\
<div id="uhunt_series_widget_ranklist_filter_dialog" title="Ranklist Configuration">\
<p class="uhunt_text">Each line starts with a color name followed by UVa user ids separated by a space.<br>\
Click the "Highlight" button to highlight the users by the specified color in the ranklist.<br>\
Click the "Filter" button to show only users listed in this configuration.</p>\
<textarea style="font-size:12px" id="uhunt_series_widget_ranklist_filter_ta" rows="8" cols="80">\
blue 258637\n\n\
</textarea>\
<p class="uhunt_text">This is useful to highlight users from by universities, year, etc.</p>\
</div>';  
    },

    ranklist: function (series_index) {
      var ptr = '<th width="35">#\
        <th width="150" align=left> &nbsp;User (username)\
        <th width="80">Solved';
      var ser = series.series[series_index];
      for (var i = 0; i < ser.problems.length; i++) {
        ptr += '<th>' + uhunt.tpl.problem_link(uhunt.probs.num(ser.problems[i].id));
      }
      var conf = uhunt.db.get('uhunt_series_filter_uids');
      return '\
<table width="100%" style="border: 1px solid #AAA; margin:15px 0 15px 0;">\
  <thead><tr class="tablebar">\
    <th align="left" colspan="'+ (4 + series.series[series_index].problems.length) +'" height="25">\
      <span id="uhunt_widget_contest_status_'+series_index+'" style="float:right; margin-right:10px; font-weight:normal"></span>\
      &nbsp; <a style="text-decoration:none; color:white">Ranklist</a>\
    <tr class="tablesubar">' + ptr +'\
  </thead>\
  <tbody id="uhunt_series_widget_ranklist_tbody_'+series_index+'" class="alt_colors" style="font-family:verdana; font-size:11px">\
</tbody></table>';
    },

    tabs_menu: function(opts){
      var ret = '';
      $.each(series.series, function (i, ser) {
        ret += '<li><a class="tab_menu" href="#w'+(i+1)+'">' + (i+1) + '</a></li>';
      });
      return ret;
    },

    tabs_content: function(opts){
      var ret = '';
      $.each(series.series, function (i, ser) {
        ret += '<div id="w'+(i+1)+'" style="padding:12px">' + 
        '<div style="width:480px; float:right; margin:5px 0 0 25px">' + widget.problems(ser.problems) + '</div>' +
        '<p style="margin-top:10px; font-weight:bold">Session #' + (i+1) + ' - ' + uhunt.util.escape_html(ser.title) + '</p>' +
        '<div style="font-size:13px">'+ser.description+'</div><br style="clear:both">' +
        '<div id="uhunt_series_widget_livesubs_'+i+'"></div>' + 
        widget.ranklist(i) + '</div>';
      });
      return ret;
    },

    tabs: function (opts) {
      return '\
<div id="tabs">\
  <ul style="border:0; border-bottom:1px solid #8cf">\
    <li><a class="tab_menu" href="#w0">Home</li></a>' +
    widget.tabs_menu(opts) +
    // '<li><a class="tab_menu" href="#ratings">Ratings</a></li>' +
  '</ul>\
  <div id="w0" style="padding:12px">'+series.description+'</div>' +
  widget.tabs_content(opts) +
  // '<div id="ratings" style="padding:12px">\
  //   <table>\
  //   <tr><td>Ratings\
  //   </table>\
  // </div>' +
'</div>';
    },
  };

  var interesting_pids = {};
  var interesting_pids_vector = [];
  var filter_uids = {};
  var tab_el;

  function init(_series, _tab_el) {
    series = _series;
    tab_el = _tab_el;

    $.each(series.series, function (i, ser){
      ser.start_sbt = uhunt.util.to_uts(ser.start_ts);
      ser.end_sbt = uhunt.util.to_uts(ser.end_ts);
      $.each(ser.problems, function (j, dict){
        var num = dict.id;
        var pid = uhunt.probs.num(num).pid;
        if (!interesting_pids[pid]) {
          interesting_pids[pid] = [];
          interesting_pids_vector.push(pid);
        }
        interesting_pids[pid].push(i);
      });
    });

    register_all_observers();
    uhunt.observer.add_listener('problem_reloaded', function () {
      console.log('Construct Tabs');
      construct_tabs();
      uhunt.livesubs = [];
      $.each(series.series, function (i, ser) {
        uhunt.livesubs[i] = new uhunt.Livesubs('uhunt_series_widget_livesubs_tbody_' + i, 100000);
        $('#uhunt_series_widget_livesubs_' + i)[0].outerHTML = 
          uhunt.livesubs[i].render('Live Submissions', 
                             ['sid', 'prob', 'user', 'ver', 'lan', 'run', 'mrun', 'rank', 'sbt'],
                             [ 5, 10, 20, 50, 100, 1e10 ], i);
      });
      out_of_sync();
    });
    load_problems();
  }

  function update_ranklist_status(series_index, ser) {
    var status = '', ser = series.series[series_index], c = uhunt.util.now();
    if (ser.start_sbt > c){
      var t = uhunt.tpl.format_time_v(ser.start_sbt - c, 1);
      if (t===false) status = 'Contest start date: ' + uhunt.tpl.format_date(ser.start_sbt);
      else status = 'Will start in: ' + t;
    }
    else if (ser.end_sbt < c) status = 'Contest has ended';
    else {
      var t = uhunt.tpl.format_time_v(ser.end_sbt - c, 1);
      if (t===false) status ='Contest start date: ' + uhunt.tpl.format_date(ser.start_sbt) + '-' + 'Contest end date: ' + uhunt.tpl.format_date(ser.end_sbt);
      else status = 'Time remaining: <font color=yellow>' + t + '</font>';
    }
    $('#uhunt_widget_contest_status_' + series_index).html(status);
  }

  var ranklists = false;

  function render_ranklists() {
    if (!ranklists) return;
    for (var i = 0; i < ranklists.length; i++) {
      ranklists[i].render();
    }
  }

  function ranklist_filter(highlight, filter) {
    var conf = uhunt.db.get('uhunt_series_filter_uids');
    if (!conf) return;
    var highlighted = '';
    filter_uids = {};
    for (var i = 0; i < conf.length; i++) {
      var c = conf[i].split(' ');
      for (var j = 1; j < c.length; j++) {
        var uid = uhunt.util.parseInt(c[j]);
        if (filter) filter_uids[uid] = true;
        if (highlight) highlighted += 'a[uid="'+uid+'"] { font-weight: bold; color: ' + c[0] + '; }\n';
      }
    }
    $('#uhunt_series_ranklist_style').html(highlighted);
    uhunt.db.set('uhunt_widget_highlight_uids_chk', highlight);
    uhunt.db.set('uhunt_widget_filter_uids_chk', filter);
    render_ranklists();
  }

  function problem_link_color_update() {
    if (!uhunt.db.get('logged-in')) return;
    console.log('update problem colors');
    $('a[num]').each(function (i, el) { uhunt.util.apply_color_class(el); });
  }

  function load_ranklist(cb) {
    if (!ranklists) {
      ranklists = [];
      $.each(series.series, function (i, ser) {
        ranklists[i] = new Ranklist(i);
      });
    }
    console.log('Loading ranklist');
    var cnt = ranklists.length;
    $.each(ranklists, function(i, r) {
      // console.log('load ranklist ' + i);
      r.load(function (){ if (--cnt == 0) load_summary_ranklist(cb); });
    });
    if (ranklists.length == 0) load_summary_ranklist(cb);
  }

  function total_cmp(a, b) { return b.total - a.total; }
  function load_summary_ranklist(cb) {
    var users = {};
    for (var i = 0; i < ranklists.length; i++) {
      var u = ranklists[i].getUsers();
      for (var uid in u) if (u.hasOwnProperty(uid)) {
        var user = u[uid], ac = 0;
        user.each_pid(function (pid) { if (user.stats(pid).ac) ac++; });
        if (!users[uid]) users[uid] = { solved:[], total:0 };
        users[uid].uid = uid;
        users[uid].name = user.name();
        users[uid].uname = user.uname();
        users[uid].solved[i] = ac;
        users[uid].total += ac;
      }
    }
    var arr = [], s = '';

    var conf = uhunt.db.get('uhunt_series_filter_uids');
    var student_ids = [];
    for (var user in conf) {
      var id = conf[user].split(' ')[1];
      student_ids.push(id);
    }

    for (var user in users) {
      if (users[user] !== undefined && users[user].hasOwnProperty("uid")) {
        if (student_ids.indexOf(users[user].uid) > -1) {
          arr.push(users[user]);
        }
      }
    }

    arr.sort(total_cmp);
    for (var i = 0; i < arr.length; i++) {
      var u = arr[i];
      s += '<tr><td align="center">' + (i+1) +
        '<td>' + uhunt.tpl.username(u.uid, u.name + ' (' + u.uname + ')', 175);
      s += '<td align="center" style="font-weight:bold">' + u.total;
      for (var j = 0; j < ranklists.length; j++)
        s += '<td align="center">' + (u.solved[j] || 0);
    }
    if (s.length == 0) {
      s = '<tr><th colspan="16">No Ranklist Yet</tr>';
      update_summary();
    }
    $('#summary_tbody').html(s);
  }

  var start_tss = 1421244000000;
  var displayed = new Date().getTime() > start_tss;
  function update_summary() {
    var si = 'Session #1 will begin in ';
    var sis = (start_tss - new Date().getTime()) / 1000;
    console.log('update_summary ' + sis);
    if (sis < 0) {
      if (!displayed) {
        displayed = true;
        $('#summary_status').html('Session #1 has started, please refresh.');
      }
    } else if (sis < 60) {
      $('#summary_status').html(si + Math.floor(sis) + ' seconds.');
      setTimeout(update_summary, 1000);
    } else if (sis < 60 * 60) {
      $('#summary_status').html(si + Math.floor(sis / 60) + ' minutes.');
      setTimeout(update_summary, 1000 * 10);
    } else if (sis < 60 * 60 * 24) {
      $('#summary_status').html(si + Math.floor(sis / 60 / 60) + ' hours.');
      setTimeout(update_summary, 1000 * 60);
    } else {
      $('#summary_status').html(si + Math.floor(sis / 60 / 60 / 24) + ' days.');
      setTimeout(update_summary, 1000 * 60);
    }
  }

  function out_of_sync() {
    var cnt = 2;
    load_ranklist(function () {
      if (--cnt == 0) uhunt.observer.notify('problem_link_color_update');
    });

  }
  
  function submissions(subs){
    var reload = {};
    // console.log('got %d submissions', subs.length);
    for (var i=0; i<subs.length; i++) {
      var s = subs[i];
      if (!interesting_pids[s.pid]) continue;
      var idxs = interesting_pids[s.pid];
      // console.log(s);
      for (var j=0; j<idxs.length; j++) {
        var ser = series.series[idxs[j]];
        if (ser.start_sbt <= s.sbt && s.sbt < ser.end_sbt) {
          ranklists[idxs[j]].update(s);
          uhunt.livesubs[idxs[j]].update(s, subs.length < 20);
          reload[idxs[j]] = true;
        }
      }
    }
    uhunt.util.adjust_delta_time(s.sbt);
    for (var i in reload) if (reload.hasOwnProperty(i)) {
      ranklists[i].render();
      if (subs.length >= 20)
        uhunt.livesubs[i].update_display();
    }
  }

  function register_all_observers() {
    $.each(series.series, function (series_index, ser) {
      uhunt.observer.add_listener('a_submission_for_' + series_index, function(s, use_effect){
        ranklists[series_index].update(s);
        uhunt.livesubs[series_index].update(s, use_effect);
      });
      uhunt.observer.add_listener('periodic_update_1000', function (){
        update_ranklist_status(series_index, ser);
      });
    });
    uhunt.observer.add_listener('ranklist_filter', ranklist_filter);
    uhunt.observer.add_listener('problem_link_color_update', problem_link_color_update);
  }

  function load_problems() {
    var all_ok = true;
    $.each(series.series, function (series_index, ser) {
      $.each(ser.problems, function (i,dict) {
        var num = dict.id;
        if (!uhunt.probs.num(num)) return all_ok = num;
      });
    });
    if (all_ok !== true) {
      console.log('Problems incomplete, reload!');
      uhunt.probs.reload();
    } else {
      uhunt.observer.notify('problem_reloaded');
    }
  }

  function construct_tabs() {
    tab_el.html(widget.tabs());
    $('#tabs').tabs();
    $('#tabs').tabs({
      activate: function(event, ui) {
        var active = $('#tabs').tabs('option','active');
        uhunt.db.set('series_index', active);
      }
    });

    $("#tabs").tabs({
      beforeActivate: function(event, ui) {
        if (document.location.hash != ui.newPanel.selector) {
          document.location.hash = ui.newPanel.selector + ';';
          // return false;
        }
        return true;
      }
    });

    uhunt.observer.add_listener('hashchange', function (hash) {
      var idx = hash ? uhunt.util.parseInt(hash.substr(1)) : uhunt.db.get('series_index');
      $("#tabs").tabs('option', 'active', idx);
    });
    $(window).trigger('hashchange');
  }

  function Ranklist(series_index) {
    var ser = series.series[series_index];
    var users = {};

    function sbt_cmp(a, b) { return a.sbt - b.sbt; }
    function ac_pen_cmp(a, b) { return (a[0] != b[0]) ? (b[0] - a[0]) : (a[1] - b[1]); }

    this.getUsers = function () { return users; };

    this.render = function () {
      var arr = [], filter = uhunt.db.get('uhunt_widget_filter_uids_chk');
      var this_uid = uhunt.db.get('logged-in');
      var acnos = {};
      for (var uid in users) if (users.hasOwnProperty(uid)) {
        var u = users[uid], nac = 0, pen = 0, row = '';
        if (filter && !filter_uids[uid]) continue;
        for (var i = 0; i < ser.problems.length; i++) {
          var num = ser.problems[i].id;
          var p = u.stats(uhunt.probs.num(num).pid);
          if (!acnos[num]) acnos[num] = { ac: 0, nos: 0 };
          else {
            acnos[num].ac += p.ac;
            acnos[num].nos += p.ntry;
          }
          var is_owner = this_uid == uhunt.util.parseInt(uid);
          var bold = is_owner? ' style="font-weight:bold" ' : '';
          if (p.ac) {
            var cur_pen = p.first_ac_sbt - ser.start_ts/1000 + p.ntry * 20 * 60; // 20 minutes penalty for every wrong try
            pen += cur_pen;
            //row += "<td align=center style='background-color:green' nowrap "+bold+">" + uhunt.tpl.format_dhms(cur_pen, false) + (p.ntry? ("(" + p.ntry + ")") : '');
            row += "<td align=center style='background-color:#B1810B' nowrap "+bold+">" + uhunt.tpl.format_dhms(cur_pen, false);
            nac++;
          } else if (p.ntry) {
            row += "<td align=center style='background-color:#000' "+bold+">";
          } else {
            row += "<td align=center "+bold+">-";
          }
        }
        // <span style="width:145px; font-weight:'+ ((filter_uids[uid] || is_owner)?'bold':'normal')+'" class=ellipsis>' + u.name() + ' (' + u.uname() + ')' + '<span>
        var uname = uhunt.tpl.username(uid, u.name() + ' (' + u.uname() + ')', 145);
        arr.push([nac, pen, '<td> &nbsp;' + uname + '<td align=right style="padding-right:10px" nowrap ' +
          bold +'><b>' + nac + '</b> / ' + uhunt.tpl.format_dhms(pen, true) + row]);
      }
      arr.sort(ac_pen_cmp);
      var s = '';
      for (var i = 0; i < arr.length; i++) {
        s += '<tr><td align=center>' + (i + 1) + arr[i][2];
      }

      for (var num in acnos) if (acnos.hasOwnProperty(num)) {
        $('#session-ac-' + num).html(acnos[num].ac);
        $('#session-nos-' + num).html(acnos[num].nos);
      }
      $('#uhunt_series_widget_ranklist_tbody_'+series_index).html(s);
    };

    this.update = function (s) {
      if (!users[s.uid]) users[s.uid] = uhunt.NewUser();
      users[s.uid].update(s);
    };

    this.load = function(cb) {
      var pids = [], thisRef = this, t1 = uhunt.util.time();
      $.each(ser.problems, function (i, dict) { pids.push(uhunt.probs.num(dict.id).pid); });
      uhunt.rpc.psubs(pids, uhunt.util.to_uts(ser.start_ts), uhunt.util.to_uts(ser.end_ts), function (arr) {
        var t2 = uhunt.util.time();
        arr.sort(sbt_cmp);
        for (var i = 0; i < arr.length; i++) {
          uhunt.observer.notify('a_submission_for_' + series_index, arr[i], arr.length < 20);
        }
        var t3 = uhunt.util.time();
        if (arr.length >= 20)
          uhunt.livesubs[series_index].update_display();
        var t4 = uhunt.util.time();
        thisRef.render();
        var t5 = uhunt.util.time();
        console.log('session[%d] = %d, RPC %d, SUBS %d, LIVESUBS %d, RENDER %d', 
          series_index, arr.length, t2-t1, t3-t2, t4-t3, t5-t4);
        cb();
      });
    };
  }

  return {
    init: init,
    widget: widget,
    handle: { show: function (i, n){ livesubs[i].show(n); }, },
    on_submissions: submissions,
    on_out_of_sync: out_of_sync,
  };
})();



function init_series() {
  uhunt.init(); // initialize uHunt object

  $('.uhunt_series_widget').each(function(i,a){ a = $(a);
    var opts = $.extend(eval(a.text()), { width: a.width(), height: a.height() });
    a.html(uhunt_series.widget[opts.name](opts));
  })

  $(window).bind('hashchange', function() {
    var uri = document.location.hash.substr(1);
    uhunt.observer.notify('hashchange', uri);
    return false;
  });

  uhunt_series.init(series, $('#uhunt_series_widget_tabs'));  // initialize uHunt series object

  uhunt.observer.notify('ranklist_filter',
    uhunt.db.get('uhunt_widget_highlight_uids_chk'),
    uhunt.db.get('uhunt_widget_filter_uids_chk'));

  if (!uhunt.db.get('uhunt_series_filter_uids')) {
    uhunt.db.set('uhunt_series_filter_uids', $('#uhunt_series_widget_ranklist_filter_ta').val().split('\n'));
    uhunt.observer.notify('ranklist_filter', true, false);
  }
  
  uhunt.db.set('uhunt_series_filter_uids', 
    [
      "#B1810B 258637",
      "#B1810B 212921",
      "#B1810B 623585",
      "black 860233",
      "black 798447", 
      "black 798472", 
      "black 860241", 
      "black 860235", 
      "black 860247", 
      "black 620743", 
      "black 860244", 
      "black 860242", 
      "black 860240",
      "black 860236",
      "black 860233",
      "black 860237",
      "black 860245",
      "black 799126",
      "black 860242",
      "black 860243",
      "black 863289",
      "black 863287",
    ]
  );
  uhunt.observer.notify('ranklist_filter', true, true);

  $("#uhunt_series_widget_ranklist_filter_dialog").dialog({
    autoOpen: false,
    height: 400,
    width: 650,
    modal: true,
    buttons: {
      "Highlight": function() {
        $(this).dialog("close");
        uhunt.db.set('uhunt_series_filter_uids', $('#uhunt_series_widget_ranklist_filter_ta').val().split('\n'));
        uhunt.observer.notify('ranklist_filter', true, false);
      },
      "Filter": function() {
        $(this).dialog("close");
        uhunt.db.set('uhunt_series_filter_uids', $('#uhunt_series_widget_ranklist_filter_ta').val().split('\n'));
        uhunt.observer.notify('ranklist_filter', true, true);
      },
      "Disable": function() {
        $(this).dialog("close");
        uhunt.db.set('uhunt_series_filter_uids', $('#uhunt_series_widget_ranklist_filter_ta').val().split('\n'));
        uhunt.observer.notify('ranklist_filter', false, false);
      }
    },
    close: function() {
    }
  });
}
</script>
<script src="js/uhunt.js?v=1"></script>
<script>
uHunt

.value('uhunt_version', 28)
.value('uhunt_user_uid', 0)
.value('uhunt_initial_poll', '{}')
.value('uhunt_chat_room', 'series')
.value('uhunt_api_url', 'http://uhunt.felix-halim.net')
.value('uhunt_web_url', 'http://uhunt.felix-halim.net')

.controller('DummyCtrl', function ($scope, uhunt_poll) {
  uhunt_poll.on_new_submissions(uhunt_series.on_submissions);
})

.factory('uhunt_user', function (uhunt_create_user, uhunt_user_uid, uhunt_util, uhunt_udebug, uhunt_problems) {
  var user = uhunt_create_user(uhunt_user_uid);
  user.notify_all();

  uhunt.udebug = uhunt_udebug;
  uhunt.probs = uhunt_problems;
  uhunt.probs.ready_listener(init_series);

  return user;
});
</script>
</body>
</html>
